services:
  builder:
    build:
      context: .   # Dockerfile.dev がある場所（カレントディレクトリ）
      dockerfile: development/Dockerfile.builder
      args:
        UID: ${UID}
        GID: ${GID}
    container_name: spring-builder
    volumes:
      - .:/workspace
    working_dir: /workspace
    stdin_open: true      # コンテナに対話的に入れる（例: bash）
    tty: true    # 仮想ターミナルを有効化
    command: bash  # ← シェルを起動

    #environment:
      # VS Code Serverのホームディレクトリを/home/devuserに設定
      # これにより、/rootではなく、この非rootユーザーのホームディレクトリにVS Code Serverのファイルが作成されます。
      # - VSCODE_SERVER_CONTAINER_USER_HOME=/home/devuser
  appserver:
    build:
      context: .
      dockerfile: development/Dockerfile.appserver
    container_name: spring-appserver
    expose:
      - "8080"
      - "8000"  # ← デバッグ用ポート
    volumes:
      #- ./spring-webapp/target/spring-webapp.war:/usr/local/tomcat/webapps/spring-webapp.war:ro
      - ./development/tomcat/server.xml:/usr/local/tomcat/conf/server.xml:ro
      #- ./development/tomcat/certs/keystore.p12:/usr/local/tomcat/conf/keystore.p12:ro
  webserver:
    image: httpd:2.4.63-alpine # Apache HTTP Serverのイメージ
    container_name: apache-webserver
    ports:
      - "8443:8443"                   # 外部公開ポート
      - "80:80"                   # リダイレクトさせる
    depends_on:
      - appserver
    volumes:
      - ./development/apache/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./development/apache/conf.d:/usr/local/apache2/conf/conf.d:ro
      - ./development/apache/certs:/usr/local/apache2/conf/certs:ro
  db:
    image: postgres:16-alpine  # デフォルトは 16-alpine
    container_name: postgres-db
    restart: unless-stopped # コンテナが停止した場合、再起動する
    env_file:
      - .env                # 下記の変数を読み込む
    environment:            # .env で定義した値をそのまま渡す
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: Asia/Tokyo # タイムゾーンを設定
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "${PG_PORT:-5432}:5432" # 環境変数が設定されていない場合はデフォルトの5432を使用
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"] # データベースが起動しているか確認するコマンド
      interval: 10s # 健康チェックの間隔
      timeout: 5s # 健康チェックのタイムアウト
      retries: 5 # 健康チェックの再試行回数
  certbuilder:
    build:
      context: .
      dockerfile: development/Dockerfile.certbuilder
    container_name: ssl-certbuilder
    user: "${UID}:${GID}"
    volumes:
      - ./build-certs:/certs   # ← 出力先（ホスト共有）
volumes:
  db-data:                             # 永続化用